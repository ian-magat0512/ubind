// <auto-generated />
#pragma warning disable 1591

// <copyright file="UserPasswordResetInvitationServiceIntegrationTests.cs" company="uBind">
// Copyright (c) uBind. All rights reserved.
// </copyright>

// If you edit this file, you must remove this line and then do proper null checking
#pragma warning disable CS8600, CS8625, CS8629, CS8618, CS8605, CS8604, CS8601, CS8602, CS8603, CS8622, CS8619, CS8767, CS8620, CS8765


namespace UBind.Persistence.Tests.IntegrationTests.Users
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using FluentAssertions;
    using Moq;
    using NodaTime;
    using UBind.Domain;
    using UBind.Domain.Aggregates.Organisation;
    using UBind.Domain.Aggregates.Person;
    using UBind.Domain.Aggregates.User;
    using UBind.Domain.Authentication;
    using UBind.Domain.Entities;
    using UBind.Domain.Extensions;
    using UBind.Domain.ReadModel;
    using UBind.Persistence.Tests.Fakes;
    using Xunit;
    using UBind.Domain.ReadModel.User;
    using UBind.Domain.Services;
    using UBind.Application.Tests;
    using UBind.Application.Commands.User;
    using UBind.Application.Commands.Authentication;
    using UBind.Domain.Patterns.Cqrs;
    using UBind.Domain.Aggregates;
    using UBind.Domain.Repositories;
    using UBind.Domain.Events;
    using UBind.Domain.Exceptions;

    [Collection(DatabaseCollection.Name)]
    public class UserPasswordResetInvitationServiceIntegrationTests
    {
        private ApplicationStack stack;
        private readonly Guid? performingUserId = Guid.NewGuid();
        private readonly ICqrsMediator mediator;

        public static IClock Clock { get; set; } = SystemClock.Instance;

        public UserPasswordResetInvitationServiceIntegrationTests()
        {
            this.stack = new ApplicationStack(DatabaseFixture.TestConnectionStringName);
        }

        [Fact]
        public async Task CreateAndSendPasswordInvitation_Success_AttemptOnce()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisationAggregate = Organisation.CreateNewOrganisation(
                tenant.Id,
                tenant.Details.Alias,
                tenant.Details.Name,
                null, this.performingUserId,
                this.stack.Clock.GetCurrentInstant());
            await this.stack.OrganisationAggregateRepository.Save(organisationAggregate);
            tenant.SetDefaultOrganisation(
                organisationAggregate.Id, this.stack.Clock.GetCurrentInstant().Plus(Duration.FromMinutes(1)));
            this.stack.TenantRepository.SaveChanges();
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);

            var role = UserType.Master;
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);

            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            var id = Guid.NewGuid();

            // create user
            var email = new Random().Next(1, 5000) + "jeo@gmail.com";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // Act
            var resetInvitationResult = await this.stack.UserPasswordResetInvitationService.CreateAndSendPasswordResetInvitation(
                tenant.Id,
                tenant.Details.DefaultOrganisationId,
                email,
                environment,
                isPasswordExpired: false);

            //Assert
            resetInvitationResult.Should().Succeed();
        }

        [Fact]
        public async Task CreateAndSendPasswordInvitationWithExpiredPassword_Success_AttemptOnce()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisationAggregate = Organisation.CreateNewOrganisation(
                tenant.Id,
                tenant.Details.Alias,
                tenant.Details.Name,
                null, this.performingUserId,
                this.stack.Clock.GetCurrentInstant());
            await this.stack.OrganisationAggregateRepository.Save(organisationAggregate);
            tenant.SetDefaultOrganisation(
                organisationAggregate.Id, this.stack.Clock.GetCurrentInstant().Plus(Duration.FromMinutes(1)));
            this.stack.TenantRepository.SaveChanges();
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);

            var role = UserType.Master;
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);

            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            var id = Guid.NewGuid();

            // create user
            var email = new Random().Next(1, 5000) + "ken@gmail.com";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // Act
            var resetInvitationResult = await this.stack.UserPasswordResetInvitationService.CreateAndSendPasswordResetInvitation(
                tenant.Id,
                tenant.Details.DefaultOrganisationId,
                email,
                environment,
                isPasswordExpired: true);

            //Assert
            resetInvitationResult.Should().Succeed();

        }

        [Fact]
        public async Task CreateAndSendPasswordInvitation_Success_AttemptConsecutivelyWithinLimit()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisationAggregate = Organisation.CreateNewOrganisation(
                tenant.Id,
                tenant.Details.Alias,
                tenant.Details.Name,
                null, this.performingUserId,
                this.stack.Clock.GetCurrentInstant());
            await this.stack.OrganisationAggregateRepository.Save(organisationAggregate);
            tenant.SetDefaultOrganisation(
                organisationAggregate.Id, this.stack.Clock.GetCurrentInstant().Plus(Duration.FromMinutes(1)));
            this.stack.TenantRepository.SaveChanges();
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);

            var role = UserType.Master;
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);

            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            var id = Guid.NewGuid();

            // create user
            var email = new Random().Next(1, 5000) + "jeo@gmail.com";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // Act
            for (int i = 0; i < this.stack.UserPasswordResetInvitationService.PasswordResetRequestBlockingThreshold; i++)
            {
                // Act
                var command = new CreateAndSendResetPasswordInvitationCommand(
                    tenant.Id,
                    tenant.Details.DefaultOrganisationId,
                    email,
                    environment,
                    isPasswordExpired: false);
                var handler = new CreateAndSendResetPasswordInvitationCommandHandler(
                    this.stack.PasswordResetTrackingService,
                    this.stack.CachingResolver,
                    this.stack.UserPasswordResetInvitationService,
                    this.stack.HttpContextPropertiesResolver,
                    this.stack.JobClient);

                Func<Task> act = async () => await handler.Handle(command, default);

                // Assert
                await act.Should().NotThrowAsync();
            }
        }

        [Fact]
        public async Task CreateAndSendPasswordInvitation_Fail_AttemptConsecutivelyBeyondLimit()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisationAggregate = Organisation.CreateNewOrganisation(
                tenant.Id,
                tenant.Details.Alias,
                tenant.Details.Name,
                null, this.performingUserId,
                this.stack.Clock.GetCurrentInstant());
            await this.stack.OrganisationAggregateRepository.Save(organisationAggregate);
            tenant.SetDefaultOrganisation(
                organisationAggregate.Id, this.stack.Clock.GetCurrentInstant().Plus(Duration.FromMinutes(1)));
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);

            var role = UserType.Master;
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);

            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            var id = Guid.NewGuid();

            // create user
            var email = new Random().Next(1, 5000) + "jeo@gmail.com";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // Act
            for (int i = 0; i < this.stack.UserPasswordResetInvitationService.PasswordResetRequestBlockingThreshold + 1; i++)
            {
                // Act
                var command = new CreateAndSendResetPasswordInvitationCommand(
                    tenant.Id,
                    tenant.Details.DefaultOrganisationId,
                    email,
                    environment,
                    isPasswordExpired: false);
                var handler = new CreateAndSendResetPasswordInvitationCommandHandler(
                    this.stack.PasswordResetTrackingService,
                    this.stack.CachingResolver,
                    this.stack.UserPasswordResetInvitationService,
                    this.stack.HttpContextPropertiesResolver,
                    this.stack.JobClient);

                Func<Task> act = async () => await handler.Handle(command, default);

                // Assert
                // the last result is fail
                if (i == this.stack.UserPasswordResetInvitationService.PasswordResetRequestBlockingThreshold)
                {
                    (await act.Should().ThrowAsync<ErrorException>())
                        .Which.Error.Code.Should().Be("user.reset.password.too.many.attempts");
                }
                else
                {
                    await act.Should().NotThrowAsync();
                }
            }
        }

        [Fact]
        public async Task CreateAndSendPasswordInvitation_Success_AttemptMultipleTimesWithoutTriggeringOccurence()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisation = Organisation.CreateNewOrganisation(tenant.Id, default, default, null, default, this.stack.Clock.Now());
            tenant.SetDefaultOrganisation(organisation.Id, this.stack.Clock.Now().Plus(Duration.FromDays(1)));
            await this.stack.CreateOrganisation(organisation);
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);
            var role = UserType.Master;
            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            var id = Guid.NewGuid();

            // create user
            var email = new Random().Next(1, 5000) + "jeo@gmail.com";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // shorten the issue time it takes to call a reset password block function
            this.stack.UserPasswordResetInvitationService.PasswordResetTrackingPeriodInMinutes = 1;
            this.stack.UserPasswordResetInvitationService.PasswordResetRequestBlockingThreshold = 1;

            // Act
            for (int i = 0; i < 4; i++)
            {
                // wait for a time the block interval is gone.
                this.stack.Clock.Increment(Duration.FromMinutes(1 * (i + 1)));

                // Act
                var command = new CreateAndSendResetPasswordInvitationCommand(
                    tenant.Id,
                    tenant.Details.DefaultOrganisationId,
                    email,
                    environment,
                    isPasswordExpired: false);
                var handler = new CreateAndSendResetPasswordInvitationCommandHandler(
                    this.stack.PasswordResetTrackingService,
                    this.stack.CachingResolver,
                    this.stack.UserPasswordResetInvitationService,
                    this.stack.HttpContextPropertiesResolver,
                    this.stack.JobClient);

                Func<Task> act = async () => await handler.Handle(command, default);

                // Assert
                await act.Should().NotThrowAsync();
            }
       }

        [Fact]
        public async Task SetPasswordFromResetPassword_ShouldHavePlusSignInPassword_SuccessLoginWithNewPassword()
        {
            // Arrange
            var productId = Guid.NewGuid();
            var tenantAndProduct = await TestData.CreateProductAndTenant(productId, this.stack);
            var tenant = tenantAndProduct.Tenant;
            var product = tenantAndProduct.Product;
            var organisation = Organisation.CreateNewOrganisation(tenant.Id, "alias", "name", null, default, this.stack.Clock.Now());
            tenant.SetDefaultOrganisation(organisation.Id, this.stack.Clock.Now().Plus(Duration.FromDays(1)));
            await this.stack.OrganisationAggregateRepository.Save(organisation);
            this.stack.TenantRepository.SaveChanges();
            this.stack.MockMediator.GetTenantByIdOrAliasQuery(tenant);
            this.stack.MockMediator.GetProductByIdOrAliasQuery(product);

            var role = UserType.Master;
            var password = "ubindTest123*";
            var newPassword = "+ubindTest123*";

            var fakeLoginAttemptResultRepository = new FakeLoginAttemptResultRepository();
            var fakeEmailBlockingEventRepository = new FakeEmailBlockingEventRepository();
            var passwordHashingService = new PasswordHashingService();
            var userAggregateRepository = new Mock<IUserAggregateRepository>();
            var userReadModelRepository = new Mock<IUserReadModelRepository>();
            var organisationService = new Mock<IOrganisationService>();
            var userSystemEventEmitter = new FakeUserSystemEventEmitter();
            var userLoginEmailRespository = new Mock<IUserLoginEmailRepository>();
            var loginTrackingService = new LoginAttemptTrackingService(
                fakeLoginAttemptResultRepository,
                fakeEmailBlockingEventRepository,
                this.stack.OrganisationAggregateRepository,
                userSystemEventEmitter,
                userLoginEmailRespository.Object,
                SystemClock.Instance);

            var environment = DeploymentEnvironment.Staging;
            var clock = SystemClock.Instance;

            // create user
            var email = new Random().Next(1, 5000) + "elvien@ubind.io";
            var userAggregate = await this.CreateUser(tenant.Id, environment, role, email);

            // actvate the user.
            userAggregate = this.stack.UserAggregateRepository.GetById(tenant.Id, userAggregate.Id);
            var invitationId = userAggregate.CreateActivationInvitation(this.performingUserId, clock.GetCurrentInstant());
            var saltedHashedPassword = this.stack.PasswordHashingService.SaltAndHash(password);
            userAggregate.Activate(invitationId, saltedHashedPassword, this.performingUserId, clock.GetCurrentInstant());
            await this.stack.UserAggregateRepository.Save(userAggregate);

            // reset password
            var resetInvitationResult = await this.stack.UserPasswordResetInvitationService.CreateAndSendPasswordResetInvitation(
                tenant.Id,
                tenant.Details.DefaultOrganisationId,
                email,
                environment,
                isPasswordExpired: false);
            resetInvitationResult.Should().Succeed();

            // Act
            await this.stack.UserPasswordResetInvitationService.SetPasswordFromPasswordReset(
                tenant.Id,
                userAggregate.Id,
                resetInvitationResult.Value,
                newPassword);

            var personAggregate = PersonAggregate.CreatePerson(
                tenant.Id,
                organisation.Id,
                this.performingUserId,
                SystemClock.Instance.GetCurrentInstant());

            var personData = new PersonData(personAggregate);
            var userReadModel = new UserReadModel(
                Guid.NewGuid(),
                personData,
                Guid.NewGuid(),
                null,
                SystemClock.Instance.GetCurrentInstant(),
                UserType.Client,
                userAggregate.Environment);

            userReadModelRepository.Setup(urs => urs.GetUser(tenant.Id, userAggregate.Id)).Returns(userReadModel);

            var command = new AuthenticateUserCommand(
                tenant.Id,
                organisation.Id,
                email,
                newPassword);

            // Assert
            // Authenticate user with new password.
            Func<Task<UserReadModel>> act = async () => await this.stack.Mediator.Send(command);

            await act.Should().NotThrowAsync();
        }

        public async Task<UserAggregate> CreateUser(
            Guid tenantId, DeploymentEnvironment environment, UserType userType, string email)
        {
            var clock = this.stack.Clock;
            var tenant = this.stack.TenantRepository.GetTenantById(tenantId);
            var personCommonProperties = new PersonCommonProperties
            {
                Email = email
            };
            var person = PersonAggregate.CreatePersonFromPersonalDetails(
                tenant.Id,
                tenant.Details.DefaultOrganisationId,
                new PersonalDetails(tenant.Id, personCommonProperties),
                this.performingUserId,
                clock.Now());

            await this.stack.PersonAggregateRepository.Save(person);
            var userId = Guid.NewGuid();
            var persistedUserAggregate = UserAggregate.CreateUser(
                person.TenantId, userId, userType, person, this.performingUserId, null, clock.Now());
            await this.stack.UserAggregateRepository.Save(persistedUserAggregate);

            return persistedUserAggregate;
        }

        private class FakeLoginAttemptResultRepository : IEmailRequestRecordRepository<LoginAttemptResult>
        {
            private readonly List<LoginAttemptResult> loginAttemptResults = new List<LoginAttemptResult>();

            public IEnumerable<LoginAttemptResult> GetLatestRecords(
                Guid tenantId, Guid organisationId, string emailAddress, int max = 5)
            {
                return this.loginAttemptResults
                    .Where(r => r.TenantId == tenantId)
                    .Where(r => r.OrganisationId == organisationId)
                    .Where(r => r.EmailAddress == emailAddress)
                    .OrderByDescending(r => r.CreatedTicksSinceEpoch)
                    .Take(max)
                    .ToList();
            }

            public void Insert(LoginAttemptResult loginAttempt)
            {
                this.loginAttemptResults.Add(loginAttempt);
            }

            public void SaveChanges()
            {
                // No op;
            }
        }

        private class FakeEmailBlockingEventRepository : IEmailAddressBlockingEventRepository
        {
            private readonly List<EmailAddressBlockingEvent> emailBlockingEvents = new List<EmailAddressBlockingEvent>();

            public EmailAddressBlockingEvent GetLatestBlockingEvent(
                Guid tenantId, Guid organisationId, string emailAddress)
            {
                return this.emailBlockingEvents
                    .Where(e => e.TenantId == tenantId)
                    .Where(e => e.OrganisationId == organisationId)
                    .Where(e => e.EmailAddress == emailAddress)
                    .OrderByDescending(e => e.CreatedTicksSinceEpoch)
                    .FirstOrDefault();
            }

            public void Insert(EmailAddressBlockingEvent lockingEvent)
            {
                this.emailBlockingEvents.Add(lockingEvent);
            }

            public void SaveChanges()
            {
                // No op;
            }
        }

        private class FakeUserSystemEventEmitter : IUserSystemEventEmitter
        {
            public Task CreateAndEmitLoginSystemEvents(Guid tenantId, Guid userId, List<SystemEventType> eventTypes, Instant? timestamp = null)
            {
                return Task.CompletedTask;
            }

            public Task CreateAndEmitLoginSystemEvents(UserReadModel user, List<SystemEventType> eventTypes, Instant? timestamp = null)
            {
                return Task.CompletedTask;
            }

            public Task CreateAndEmitSystemEvents(UserReadModel user, List<SystemEventType> eventTypes, Guid? performingUserId = null, Instant? timestamp = null)
            {
                return Task.CompletedTask;
            }

            public Task CreateAndEmitSystemEvents(Guid tenantId, Guid userId, List<SystemEventType> eventTypes, Guid? performingUserId = null, Instant? timestamp = null)
            {
                return Task.CompletedTask;
            }

            public void Dispatch(UserAggregate aggregate, IEvent<UserAggregate, Guid> @event, int sequenceNumber, IEnumerable<Type> observerTypes = null)
            {
            }
        }

        private class FakeOrganisationAggregateRepository : IOrganisationAggregateRepository
        {
            private readonly List<Organisation> organisations = new List<Organisation>();

            public Task ApplyChangesToDbContext(Organisation aggregate)
            {
                throw new NotImplementedException();
            }

            public Organisation GetById(Guid tenantId, Guid id)
            {
                return this.organisations.FirstOrDefault(o => o.Id == id);
            }

            public Task<Organisation> GetByIdAtSequenceNumber(Guid tenantId, Guid id, int sequenceNumber)
            {
                return Task.FromResult(this.organisations.FirstOrDefault(o => o.Id == id));
            }

            Task IAggregateRepository<Organisation, Guid>.DeleteById(Guid tenantId, Guid id)
            {
                // No op;
                return Task.FromResult(0);
            }

            public Task ReplayEventByAggregateId(Guid tenantId, Guid id, int sequenceNumber, IEnumerable<Type> observerTypes = null)
            {
                // No op;
                return Task.FromResult(0);
            }

            public Task ReplayAllEventsByAggregateId(
                Guid tenantId, Guid id, IEnumerable<Type> observerTypes = null, Guid? overrideTenantId = null)
            {
                // No op;
                return Task.FromResult(0);
            }

            public Task ReplayEventsOfTypeByAggregateId(Guid tenantId, Guid id, Type[] types)
            {
                // No op;
                return Task.FromResult(0);
            }

            public Task Save(Organisation aggregate)
            {
                // No op;
                return Task.FromResult(0);
            }

            public Task<Organisation> GetByIdAsync(Guid tenantId, Guid id)
            {
                // No op;
                return Task.FromResult<Organisation>(null);
            }

            public Task<Organisation> GetByIdWithoutUsingSnapshot(Guid tenantId, Guid id)
            {
                // No op;
                return Task.FromResult<Organisation>(null);
            }

            public int GetSnapshotSaveInterval()
            {
                throw new NotImplementedException();
            }
        }
    }
}
