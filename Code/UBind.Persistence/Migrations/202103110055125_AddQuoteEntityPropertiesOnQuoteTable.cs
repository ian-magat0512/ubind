// <auto-generated />
#pragma warning disable 1591
namespace UBind.Persistence.Migrations
{
    using System.Data.Entity.Migrations;
    using UBind.Persistence.Migrations.Extensions;

    public partial class AddQuoteEntityPropertiesOnQuoteTable : DbMigration
    {
        public override void Up()
        {
            this.AddColumnIfNotExists("dbo.Quotes", "Environment", c => c.Int(nullable: false));
            this.AddColumnIfNotExists("dbo.Quotes", "CustomerId", c => c.Guid(nullable: false));
            this.AddColumnIfNotExists("dbo.Quotes", "OwnerUserId", c => c.Guid(nullable: false));
            this.AddColumnIfNotExists("dbo.Quotes", "PolicyTransactionId", c => c.Guid());
            this.AddColumnIfNotExists("dbo.Quotes", "TenantId", c => c.String());
            this.AddColumnIfNotExists("dbo.Quotes", "ProductId", c => c.String());
            this.AddColumnIfNotExists("dbo.Quotes", "OrganisationId", c => c.Guid(nullable: false));
            this.AddColumnIfNotExists("dbo.Quotes", "IsTestData", c => c.Boolean(nullable: false));

            var sqlScript = @"UPDATE Q
                            SET 
                                Q.Environment = P.Environment, 
                                Q.CustomerId = P.CustomerId, 
                                Q.OwnerUserId = P.OwnerUserId, 
                                Q.PolicyTransactionId = PT.Id,
                                Q.TenantId = P.TenantId,
                                Q.ProductId = P.ProductId,
                                Q.OrganisationId = O.DefaultOrganisationId,
								Q.IsTestData = P.IsTestData
                            FROM dbo.Quotes Q
                            INNER JOIN dbo.PolicyReadModels P ON Q.PolicyId = P.Id
                            LEFT JOIN dbo.PolicyTransactions PT ON Q.Id = PT.QuoteId
							OUTER APPLY 
							(  
								SELECT TOP 1 * from [dbo].[TenantDetails]
								WHERE Tenant_Id = P.TenantId
								ORDER BY CreationTimeInTicksSinceEpoch DESC
							) O";
            Sql(sqlScript);
        }

        public override void Down()
        {
            DropColumn("dbo.Quotes", "OrganisationId");
            DropColumn("dbo.Quotes", "ProductId");
            DropColumn("dbo.Quotes", "TenantId");
            DropColumn("dbo.Quotes", "PolicyTransactionId");
            DropColumn("dbo.Quotes", "OwnerUserId");
            DropColumn("dbo.Quotes", "CustomerId");
            DropColumn("dbo.Quotes", "Environment");
            DropColumn("dbo.Quotes", "IsTestData");
        }
    }
}