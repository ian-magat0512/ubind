// <auto-generated />

namespace UBind.Persistence.Migrations
{
    using NodaTime;
    using System.Data.Entity.Migrations;
    using UBind.Domain.Extensions;

    public partial class Initialise_ProductOrganisationSettings : DbMigration
    {
        private const string tableName = "ProductOrganisationSettings";

        public override void Up()
        {
            // All Products in the "Allow New Quotes For Products" section should be enabled for existing organisations
            var timestamp = SystemClock.Instance.Now().ToUnixTimeTicks();
            var sql =
                $"INSERT INTO {tableName} (Id, TenantId, OrganisationId, ProductId, IsNewQuotesAllowed, CreationTimeInTicksSinceEpoch) " +
                $"SELECT NEWID(), prd.TenantNewId, org.OrganisationId, prd.NewId, 1, {timestamp} " +
                "FROM OrganisationReadModels org " +
                "INNER JOIN Products prd on prd.TenantId = org.TenantId " +
                "WHERE NOT EXISTS " +
                $"(SELECT 1 FROM {tableName} WHERE OrganisationId = org.OrganisationId AND ProductId = prd.NewId)";

            this.Sql(sql);
        }

        public override void Down()
        {
            this.Sql($"DELETE FROM {tableName}");
        }
    }
}